<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>demo</title>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=91fcUGbvXDaGq9Bmhzfj2GOb"></script>
	<script type="text/javascript" src="/static/js/jquery-1.11.3.js"></script>
	<style type="text/css">
	#Container{
	    width:100%;
	    margin:0 auto;	/*设置整个容器在浏览器中水平居中*/
	}
	#map{
	    width:70%;
	    height:800px;
	    margin:10px;	/*设置元素跟其他元素的距离为20像素*/
	    float:left;
	}
	#panel{
		width:20%;
	    height:800px;
	    margin:10px;
	    float:left;
	}
	#table_info {
	font-family: verdana,arial,sans-serif;
	font-size:11px;
	color:#333333;
	border-width: 1px;
	border-color: #666666;
	border-collapse: collapse;
	}
	#table_info td {
		border-width: 0px;
		padding: 8px;
		border-style: solid;
		border-color: #666666;
		background-color: #ffffff;
	}
	#host_coordinate_lng {display:inline; }
	#host_coordinate_lat {display:inline; }
	</style>
</head>

<body>
<div id="container">
<div id="map"></div>
<div id="panel">
	<table id="table_info">
	<tr>
		<td>Server Name</td>
		<td>:</td>
		<td id="host_name">{{ point_start.host_name }}</td>
	</tr>
	<tr>
		<td>Server Local IP</td>
		<td>:</td>
		<td id="host_local_ip">{{ point_start.host_local_ip }}</td>
	</tr>
	<tr>
		<td>Server Internet IP</td>
		<td>:</td>
		<td id="host_internet_ip">{{ point_start.host_internet_ip }}</td>
	</tr>
	<tr>
		<td>Server Coordinate</td>
		<td>:</td>
		<td>
			<div id="host_coordinate_lng">{{ point_start.host_coordinate_lng }}</div> N, <div id="host_coordinate_lat">{{ point_start.host_coordinate_lat }}</div> E
		</td>
	</tr>
	</table>

	<br>
	<form>
	    Enter the destination ip : <input type="text" id="ip_des" name="ip_des"> <br>
	    <p>Result:<br> <span id='result'></span></p>
	    <button type="button" id='submit_ip'>提交</button>
	</form>
</div>
</div>
</body>

</html>

<script>
var point_from = null;
var point_to = null;
var need_seq = 1;
var map = new BMap.Map("map");	
var host_coordinate_lng = $("#host_coordinate_lng").text();	//经度
var host_coordinate_lat = $("#host_coordinate_lat").text();	//纬度
map.centerAndZoom(new BMap.Point(host_coordinate_lng - 20, host_coordinate_lat - 7), 5);	//初始化地图，调整设置中心点坐标和地图级别
map.enableScrollWheelZoom();
var ip_des = null;
//画线
function drawMap(point){
	if(point.seq == 1){
		//起点
		point_from = new BMap.Point(host_coordinate_lng, host_coordinate_lat);
		point_to = new BMap.Point(point.coord[0],point.coord[1]);
		//alert('['+point.seq+']'+'point_from:'+point_from.lng+','+point_from.lat);
	}else{
		point_from = point_to;
		point_to = new BMap.Point(point.coord[0],point.coord[1]);
		//alert('['+point.seq+']'+'point_from:'+point_from.lng+','+point_from.lat);
	}
	var point_vector = [point_from, point_to];
	var polyline = new BMap.Polyline(point_vector, {strokeColor:"blue", strokeWeight:3, strokeOpacity:0.5});
	map.addOverlay(polyline); //添加到地图中
}

//根据need_seq嵌套取trace结果
/*
//getJSON方式
function getTrace(ip_des, need_seq){
    $.getJSON("{% url 'ajax_returnPoint'%}", {'ip_des':ip_des, 'need_seq': need_seq}, function(point, statusTxt, xhr){
	    	//alert("need_seq:"+need_seq+",flag:"+point.flag)
    		if (point.flag==0) {
    			$('#result').append("Total " + (need_seq - 1) + " hops<br>");
    			return;
    		}
        	//alert("Error: "+xhr.status+": "+xhr.statusText);
            $('#result').append("["+point.seq + "] " + point.city + ' : ' + point.ip + " "+ point.coord[0] + ", " + point.coord[1] + "<br>");
	        drawMap(point); 
	        //setTimeout("alert()",2000);
	        getTrace(ip_des, ++need_seq);
	    })
}
*/
function getTrace(ip_des, need_seq){
	$.ajax({
		type : "get",
		url : "ajax_returnPoint",
		//data : "ip_des=" + ip_des + "&need_seq=" + need_seq,
		data : {ip_des:ip_des, need_seq:need_seq},
		async : true,
		success : function(point, statusTxt, xhr){
			if (point.flag==0) {
				$('#result').append("Total " + (need_seq - 1) + " hops<br>");
				return;
			}
			//alert("Error: "+xhr.status+": "+xhr.statusText);
			$('#result').append("["+point.seq + "] " + point.city + ' : ' + point.ip + " "+ point.coord[0] + ", " + point.coord[1] + "<br>");
			drawMap(point);
			setTimeout("getTrace(ip_des, ++need_seq)",1000);
			//getTrace(ip_des, ++need_seq);
		},
		failure: function(errMsg){
			alert(errMsg);
        }
	});
}

$(document).ready(function(){
	$("#submit_ip").click(function(){
        ip_des = $("#ip_des").val();
        getTrace(ip_des, need_seq)
	});
});
</script>

